<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>QP-nano: 6. Signals, Events, and Active Objects</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.4 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="index.html">QP-nano Reference Manual</a>&nbsp;&raquo&nbsp;<a class="el" href="tutorial_page.html">QP-nano Tutorial</a></div>
<h1><a class="anchor" name="events">6. Signals, Events, and Active Objects </a></h1><em>This QP-nano Tutorial is adapted from Chapter 1 of <a class="el" href="index.html#PSiCC2">Practical UML Statecharts in C/C++, Second Edition</a><br>
 by Miro Samek, the founder and president of Quantum Leaps, LLC.</em><p>
<div align="center">
<img src="qp_tutorial.jpg" alt="qp_tutorial.jpg">
</div>
<p>
Prev: <a class="el" href="active_objects.html">5. Elaborating State Machines of Active Objects</a> <br>
 Next: <a class="el" href="coding_hsm.html">7. Coding Hierarchical State Machines</a><p>
In QP-nano, event signals are enumerated just like in the full-version QP. The only limitation is that signal values in QP-nano cannot exceed 255, because signals are always represented in a single byte.<p>
In QP-nano, you cannot specify arbitrary event parameters, so you don't derive events as in full-version QP. Instead, all events in QP-nano are simply instances of the <a class="el" href="struct_q_event.html" title="Event structure.">QEvent</a> structure, which contains the fixed-size scalar parameter configured according to your definition of Q_PARAM_SIZE (see Listing <a class="el" href="main_function.html#L3s2">Listing 3-2</a>(2)). On the other hand, active objects in QP-nano are derived from the <a class="el" href="struct_q_active.html" title="Active Object struct.">QActive</a> base structure, just like they are in the full-version QP (see <a class="el" href="derivation.html">Encapsulation and Single Inheritance in C</a>). One of the main concerns with respect to active object structures is to keep them encapsulated. In all QP-nano examples, including the "Fly 'n' Shoot" game, I demonstrate a technique to keep the active object structures and state machines completely opaque. I describe this technique in the explanation section following <a class="el" href="events.html#L6s1">Listing 6-1</a>, which shows the header file <code>game.h</code> included by all components of the "Fly 'n' Shoot" application.<h2><a class="anchor" name="enumerating">
6.1 Enumerating Event Signals and Encapsulating Active Objects</a></h2>
Because events are explicitly shared among most of the application components, it is convenient to declare them in the separate header file game.h shown <a class="el" href="events.html#L6s1">Listing 6-1</a>. The explanation section immediately following the listing illuminates the interesting points.<p>
<a class="anchor" name="L6s1"></a> <b>Listing 6-1 Signals, event structures, and active object interfaces defined in file game.h.</b> <div class="fragment"><pre class="fragment"> (1) <span class="keyword">enum</span> GameSignals {                              <span class="comment">/* signals used in the game */</span>
 (2)     TIME_TICK_SIG = <a class="code" href="qepn_8h.html#e35e58b2153d1c63307c068315be90746b922ebd3f2429b5b5e7b411675fda06">Q_USER_SIG</a>,                  <span class="comment">/* published from tick ISR */</span>
         PLAYER_TRIGGER_SIG, <span class="comment">/* published by Player (ISR) to trigger the Missile */</span>
         PLAYER_QUIT_SIG,          <span class="comment">/* published by Player (ISR) to quit the game */</span>
         GAME_OVER_SIG,          <span class="comment">/* published by Ship when it finishes exploding */</span>
         PLAYER_SHIP_MOVE_SIG,  <span class="comment">/* posted by Player (ISR) to the Ship to move it */</span>
         BLINK_TIMEOUT_SIG,           <span class="comment">/* signal for Tunnel's blink timeout event */</span>
         SCREEN_TIMEOUT_SIG,         <span class="comment">/* signal for Tunnel's screen timeout event */</span>
         TAKE_OFF_SIG,    <span class="comment">/* from Tunnel to Ship to grant permission to take off */</span>
         HIT_WALL_SIG,            <span class="comment">/* from Tunnel to Ship when Ship hits the wall */</span>
         HIT_MINE_SIG,     <span class="comment">/* from Mine to Ship or Missile when it hits the mine */</span>
         SHIP_IMG_SIG,     <span class="comment">/* from Ship to the Tunnel to draw and check for hits */</span>
         MISSILE_IMG_SIG,  <span class="comment">/* from Missile the Tunnel to draw and check for hits */</span>
         MINE_IMG_SIG,            <span class="comment">/* sent by Mine to the Tunnel to draw the mine */</span>
         MISSILE_FIRE_SIG,                <span class="comment">/* sent by Ship to the Missile to fire */</span>
         DESTROYED_MINE_SIG, <span class="comment">/* from Missile to Ship when Missile destroyed Mine */</span>
         EXPLOSION_SIG,     <span class="comment">/* from any exploding object to render the explosion */</span>
         MINE_PLANT_SIG,                  <span class="comment">/* from Tunnel to the Mine to plant it */</span>
         MINE_DISABLED_SIG,      <span class="comment">/* from Mine to Tunnel when it becomes disabled */</span>
         MINE_RECYCLE_SIG,         <span class="comment">/* sent by Tunnel to Mine to recycle the mine */</span>
         SCORE_SIG    <span class="comment">/* from Ship to Tunnel to adjust game level based on score */</span>
     };

     <span class="comment">/* active objects ..........................................................*/</span>
 (3) <span class="keyword">extern</span> <span class="keyword">struct</span> TunnelTag  AO_Tunnel;
 (4) <span class="keyword">extern</span> <span class="keyword">struct</span> ShipTag    AO_Ship;
 (5) <span class="keyword">extern</span> <span class="keyword">struct</span> MissileTag AO_Missile;

 (6) <span class="keywordtype">void</span> Tunnel_ctor (<span class="keywordtype">void</span>);
 (7) <span class="keywordtype">void</span> Ship_ctor   (<span class="keywordtype">void</span>);
 (8) <span class="keywordtype">void</span> Missile_ctor(uint8_t speed);

     <span class="comment">/* common constants and shared helper functions ............................*/</span>
     . . .
</pre></div><p>
<ul>
<li>(1) All signals are defined in one enumeration, which automatically guarantees the uniqueness of signals.</li>
</ul>
<ul>
<li>(2) Note that the user signals must start with the offset Q_USER_SIG to avoid overlapping the reserved QEP-nano signals.</li>
</ul>
<ul>
<li>(3-5) I declare all active object instances in the system as extern variables. These declarations are necessary for the initialization of the <code>QF_active</code>[] array (see <a class="el" href="main_function.html#L3s1">Listing 3-1</a>(12)).</li>
</ul>
<dl class="note" compact><dt><b>Note:</b></dt><dd>The active object structures (e.g., <code>struct TunnelTag</code>) do not need to be defined globally in the application header file. The <code>QF_active</code>[] array needs only pointers to the active objects (see <a class="el" href="main_function.html#L3s1">Listing 3-1</a>(9-11)), which the compiler can resolve without knowing the full definition of the active object structure.</dd></dl>
I never declare active object structures globally. Instead, I declare the active object structures in the file scope of the specific active object module (e.g., <code>struct TunnelTag</code> is declared in the <code>tunnel.c</code> file scope). That way, I can be sure that each active object remains fully encapsulated.<p>
<ul>
<li>(6-8) Every active object in the system must provide a "constructor" function, which initializes the active object instance. These constructors don't take the "me" pointers, because they have access to the global active object instances (see (3-5)). However, the constructors can take some other initialization parameters. For instance, the <code>Missile_ctor()</code> takes the Missile speed parameter. <a class="el" href="main_function.html#L3s1">Listing 3-1</a>(13-15) shows that the constructors are called right at the beginning of <code>main()</code>.</li>
</ul>
<a class="anchor" name="L6s2"></a> <b>Listing 6-2 Generating and posting events from the ISRs in bsp.c for the Cortex-M3 board.</b> <div class="fragment"><pre class="fragment"> (1) <span class="keyword">static</span> <span class="keywordtype">void</span> interrupt tmrISR(<span class="keywordtype">void</span>) {  <span class="comment">/* 80x86 enters ISRs with int. locked */</span>

 (2)     <a class="code" href="qfn_8h.html#fd1f18b068ca10c17eaa3431e77dd290" title="Processes all armed time events at every clock tick.">QF_tick</a>();                             <span class="comment">/* process all armed time events */</span>

 (3)     <a class="code" href="qfn_8h.html#d0a147ddbdfc4d9450f64515ae75f7a6" title="Posts an event e directly to the event queue of the acitve object prio using the...">QActive_postISR</a>((<a class="code" href="struct_q_active.html" title="Active Object struct.">QActive</a> *)&amp;AO_Tunnel,  TIME_TICK_SIG, 0);
 (4)     <a class="code" href="qfn_8h.html#d0a147ddbdfc4d9450f64515ae75f7a6" title="Posts an event e directly to the event queue of the acitve object prio using the...">QActive_postISR</a>((<a class="code" href="struct_q_active.html" title="Active Object struct.">QActive</a> *)&amp;AO_Ship,    TIME_TICK_SIG, 0);
 (5)     <a class="code" href="qfn_8h.html#d0a147ddbdfc4d9450f64515ae75f7a6" title="Posts an event e directly to the event queue of the acitve object prio using the...">QActive_postISR</a>((<a class="code" href="struct_q_active.html" title="Active Object struct.">QActive</a> *)&amp;AO_Missile, TIME_TICK_SIG, 0);

         outportb(0x20, 0x20);                    <span class="comment">/* write EOI to the master PIC */</span>
     }
     . . .
</pre></div><p>
<ul>
<li>(1) Usually, you can use the compiler-generated ISRs with QP-nano. Here, I use the capability of the Turbo C++ 1.01 compiler to generate ISRs, which are designated with the extended keyword "interrupt".</li>
</ul>
<ul>
<li>(2) Just like in the full-version QP, you need to call <code><a class="el" href="qfn_8h.html#fd1f18b068ca10c17eaa3431e77dd290" title="Processes all armed time events at every clock tick.">QF_tick()</a></code> from the system clock tick ISR.</li>
</ul>
<ul>
<li>(3-5) QP-nano does not support publishing events. Instead, you post directly the <code>TIME_TICK</code> event to all active objects that need to receive it.</li>
</ul>
<dl class="note" compact><dt><b>Note:</b></dt><dd>QP-nano provides different services for ISRs and different for the task level. You can only call two QP-nano functions from interrupts: <a class="el" href="qfn_8h.html#fd1f18b068ca10c17eaa3431e77dd290" title="Processes all armed time events at every clock tick.">QF_tick()</a> and <a class="el" href="qfn_8h.html#d0a147ddbdfc4d9450f64515ae75f7a6" title="Posts an event e directly to the event queue of the acitve object prio using the...">QActive_postISR()</a>. Conversely, you should never call these two functions from the task level. This separation of APIs is closely related to the separate interrupt locking policies for tasks and interrupts in QP-nano.</dd></dl>
Prev: <a class="el" href="active_objects.html">5. Elaborating State Machines of Active Objects</a> <br>
 Next: <a class="el" href="coding_hsm.html">7. Coding Hierarchical State Machines</a><p>
<div align="center">
<img src="logo_ql_TM.jpg" alt="logo_ql_TM.jpg">
</div>
 Copyright &copy; 2002-2008 Quantum Leaps, LLC. All Rights Reserved.<br>
 <a href="http://www.quantum-leaps.com">http://www.quantum-leaps.com</a> <hr size="1"><address style="text-align: right;"><small>Generated on Thu Apr 9 13:26:46 2009 for QP-nano by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.4 </small></address>
</body>
</html>
